<html>
  <head>
      <link rel="stylesheet" href="style.css" type="text/css" />
<script src="jquery-1.3.2.js" type="text/javascript"></script>
<script src="jquery.hotkeys.js" type="text/javascript"></script>

<script type="text/javascript">

var browser_ie=0;

function get_selection_range(input) {
    /*
    Return the start and end positions of the currently selected text
    in the input text area (a DOM object).

    INPUT:
        input -- a DOM object (a textarea)

    OUTPUT:
        an array of two nonnegative integers
    */
    if(browser_ie) {
        var start, end;
        var range = document.selection.createRange();

        var tmprange = range.duplicate();
        tmprange.moveToElementText(input);
        tmprange.setEndPoint("endToStart", range);
        start = tmprange.text.length;

        tmprange = range.duplicate();
        tmprange.moveToElementText(input);
        tmprange.setEndPoint("endToEnd", range);
        end = tmprange.text.length;

        return Array(start, end);
    } else {
        return Array(input.selectionStart, input.selectionEnd);
    }
}


$.fn.selectRange = function(start, end) {
        return this.each(function() {
                if(this.setSelectionRange) {
                        this.focus();
                        this.setSelectionRange(start, end);
                } else if(this.createTextRange) {
                        var range = this.createTextRange();
                        range.collapse(true);
                        range.moveEnd('character', end);
                        range.moveStart('character', start);
                        range.select();
                }
        });
};


    var i=1;
    function create_cell() {
        /* This is a safety catch: */
        if (i > 10) return;
        /* Creates a new cell by cloning the disabled prototype */
        var a = $("#cell_prototype").clone().removeClass("disabled");
        a.children(".prompt").text("In [" + i + "]:");
        a.children("a.eval_button").click(eval_click);
        a.children("div.insert_new_cell").click(insert_new_cell_click);
        a.children("textarea.cell_input").focus(cell_input_focus);
        a.children("textarea.cell_input").blur(cell_input_blur);
        a.children("textarea.cell_input").bind('keydown', 'Shift+return',
            function(event) {
                eval_click(event);
                var next_cell = $(event.target).parent().next().children("textarea.cell_input");
                next_cell.focus();
                next_cell.selectRange(1, 1);
                return true;
            });
        a.children("textarea.cell_input").bind('keydown', 'backspace',
            function(event) {
                console.log("selection", get_selection_range(event.target))
                if (get_selection_range(event.target)[0] == 0) {
                    var next_cell = $(event.target).parent().prev().children("textarea.cell_input");
                    if (next_cell.val() == "") {
                        next_cell.remove()
                    } else {
                        next_cell.focus();
                        next_cell.selectRange(1, 1);
                    }
                    return true;
                }
            });
        a.children("textarea.cell_input").bind('keydown', 'up',
            function(event) {
                var next_cell = $(event.target).parent().prev().children("textarea.cell_input");
                next_cell.focus();
                next_cell.selectRange(1, 1);
                return true;
            });
        a.children("textarea.cell_input").bind('keydown', 'down',
            function(event) {
                var next_cell = $(event.target).parent().next().children("textarea.cell_input");
                next_cell.focus();
                next_cell.selectRange(1, 1);
                return true;
            });
        i += 1;
        return a;
    };
    function insert_new_cell_click(event) {
        /* Gets called whenever the the "insert new cell" blue area is clicked,
           so this puts the new cell above the current one */
        event.preventDefault();
        $(event.target).parent().before(create_cell());
    };
    function eval_click(event) {
        /* Gets called whenever the "evaluate" link is clicked */
        event.preventDefault();
        $(event.target).parent().after(create_cell());
    };
    function cell_input_focus(event) {
        /* Gets called whenever the user "gets into" the cell */
        event.preventDefault();
        $("textarea.cell_input_active").removeClass("cell_input_active").addClass("cell_input")
        $("a.eval_button_active").removeClass("eval_button_active").addClass("eval_button");
        $(event.target).removeClass("cell_input").addClass("cell_input_active")
        $(event.target).siblings("a.eval_button").removeClass("eval_button").addClass("eval_button_active");
    };
    function cell_input_blur(event) {
        /* Gets called whenever the user "gets into" the cell */
        event.preventDefault();
        $(event.target).removeClass("cell_input_active").addClass("cell_input")
    };
$(document).ready(function(){
    $("#cell_prototype").after(create_cell());
});
</script>
<style type="text/css">
    a.test { font-weight: bold; }
</style>


    <title>Notebook</title>
  </head>
  <body>
      <h2>Notebook demo</h2>
      <p>Made using <a href="http://jquery.com/">jQuery</a></p>

<div class="disabled" id="cell_prototype">
    <div class="insert_new_cell"></div>
    <span class="prompt">In [1]:</span>
    <textarea class="cell_input" rows=1 cols=80></textarea>
    <a href="" class="eval_button" alt="Click here or press shift-return to evaluate">evaluate</a>
</div>

  </body>
</html>
